<!DOCTYPE html>
<html>
<head>
  <title>Live Delivery Viewer (Google Maps)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100vh; width: 100%; }
    .gm-style .gm-style-iw img {
      border-radius: 50%;
      width: 60px;
      height: 60px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">üìç Live Delivery Viewer (Google Maps)</span>
  </div>
</nav>

<div id="map"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.firebasestorage.app",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let map;
  const userMarkers = {};
  const userRoutes = {};
  const mashalIcon = "https://www.silvertouch.com/mailer/fire-masal.png";

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 22.9734, lng: 78.6569 },
      zoom: 5,
      minZoom: 5,
      restriction: {
        latLngBounds: {
          north: 37.1,
          south: 6.5,
          west: 67,
          east: 97.5
        },
        strictBounds: true
      }
    });

    db.ref("liveUsers").on("value", async snap => {
      const users = snap.val() || {};
      const now = Date.now();
      const bounds = new google.maps.LatLngBounds();

      for (const id in users) {
        const u = users[id];
        if ((now - u.timestamp) / 1000 > 60) continue;

        const pos = new google.maps.LatLng(u.lat, u.lng);
        bounds.extend(pos);

        const content = `
          <strong>${u.name || "User"}</strong><br>
          ${u.destination || "No destination"}<br>
          ${u.photoURL ? `<img src="${u.photoURL}" alt="photo">` : ""}
        `;

        if (!userMarkers[id]) {
          userMarkers[id] = new google.maps.Marker({
            position: pos,
            map,
            icon: {
              url: mashalIcon,
              scaledSize: new google.maps.Size(40, 40),
              anchor: new google.maps.Point(20, 40)
            }
          });
          userMarkers[id].infowindow = new google.maps.InfoWindow({ content });
          userMarkers[id].addListener("click", () => userMarkers[id].infowindow.open(map, userMarkers[id]));
        } else {
          userMarkers[id].setPosition(pos);
          userMarkers[id].infowindow.setContent(content);
        }

        if (u.toLat && u.toLng) {
          const routePath = await fetchRoute(u.lat, u.lng, u.toLat, u.toLng);
          if (routePath && routePath.length) {
            if (userRoutes[id]) userRoutes[id].setMap(null);
            userRoutes[id] = new google.maps.Polyline({
              path: routePath,
              geodesic: true,
              strokeColor: "#3366cc",
              strokeOpacity: 1.0,
              strokeWeight: 3,
              map
            });
            routePath.forEach(coord => bounds.extend(coord));
          }
        }
      }

      for (const id in userMarkers) {
        if (!(id in users) || (now - users[id]?.timestamp) / 1000 > 60) {
          userMarkers[id].setMap(null);
          delete userMarkers[id];
          if (userRoutes[id]) {
            userRoutes[id].setMap(null);
            delete userRoutes[id];
          }
        }
      }

      if (!bounds.isEmpty()) {
        map.fitBounds(bounds);
      }
    });
  }

  async function fetchRoute(lat1, lng1, lat2, lng2) {
    try {
      const key = "AIzaSyDt5vnzRbwQtgqPDAXdDHA3mqXDmSbOMSI";
      const response = await fetch(`https://routes.googleapis.com/directions/v2:computeRoutes`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Goog-Api-Key": key,
          "X-Goog-FieldMask": "routes.polyline.encodedPolyline"
        },
        body: JSON.stringify({
          origin: { location: { latLng: { latitude: lat1, longitude: lng1 } } },
          destination: { location: { latLng: { latitude: lat2, longitude: lng2 } } },
          travelMode: "DRIVE"
        })
      });
      const data = await response.json();
      const encoded = data?.routes?.[0]?.polyline?.encodedPolyline;
      if (!encoded) return null;
      return google.maps.geometry.encoding.decodePath(encoded);
    } catch (err) {
      console.warn("Route error", err);
      return null;
    }
  }
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDt5vnzRbwQtgqPDAXdDHA3mqXDmSbOMSI&callback=initMap&libraries=geometry"></script>
</body>
</html>
