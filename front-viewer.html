<!DOCTYPE html>
<html>
<head>
  <title>Live Delivery Viewer</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100%; }
    .gm-style .custom-popup img {
      width: 50px; height: 50px; border-radius: 50%; margin-top: 5px;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand mb-0">üìç Live Delivery Viewer</span>
  </div>
</nav>

<div id="map"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Google Maps JS API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDt5vnzRbwQtgqPDAXdDHA3mqXDmSbOMSI&libraries=geometry"></script>

<script>
  // Firebase setup
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.firebasestorage.app",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let map;
  const userMarkers = {};
  const userRoutes = {};

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 22.9734, lng: 78.6569 },
      zoom: 5,
      restriction: {
        latLngBounds: {
          north: 37.1, south: 6.5, west: 67.0, east: 97.5
        },
        strictBounds: true,
      },
      mapTypeControl: false,
      streetViewControl: false
    });

    listenToLiveUsers();
  }

  function listenToLiveUsers() {
    db.ref("liveUsers").on("value", async snapshot => {
      const users = snapshot.val() || {};
      const now = Date.now();
      const bounds = new google.maps.LatLngBounds();

      for (const id in users) {
        const u = users[id];
        const age = (now - u.timestamp) / 1000;
        if (age > 60) continue;

        const position = { lat: u.lat, lng: u.lng };
        bounds.extend(position);

        const infoHtml = `
          <div class="custom-popup">
            <strong>${u.name || 'User'}</strong><br>
            ${u.destination || 'No destination'}<br>
            ${u.photoURL ? `<img src="${u.photoURL}" alt="photo">` : ""}
          </div>
        `;

        if (!userMarkers[id]) {
          const marker = new google.maps.Marker({
            position,
            map,
            icon: {
              url: 'https://www.silvertouch.com/mailer/fire-masal.png',
              scaledSize: new google.maps.Size(40, 40),
            }
          });

          const info = new google.maps.InfoWindow({ content: infoHtml });
          marker.addListener('click', () => info.open(map, marker));
          marker.info = info;
          userMarkers[id] = marker;
        } else {
          animateMarker(userMarkers[id], position);
          userMarkers[id].info.setContent(infoHtml);
        }

        // Route drawing
        if (u.toLat && u.toLng) {
          const routeKey = `${id}-route`;
          const path = await getRoutePath(u.lat, u.lng, u.toLat, u.toLng);
          if (path) {
            if (userRoutes[routeKey]) userRoutes[routeKey].setMap(null);
            userRoutes[routeKey] = new google.maps.Polyline({
              path,
              strokeColor: "#1976d2",
              strokeOpacity: 1,
              strokeWeight: 3,
              map
            });
            path.forEach(p => bounds.extend(p));
          }
        }
      }

      // Remove old markers
      for (const id in userMarkers) {
        if (!users[id] || (now - users[id].timestamp) / 1000 > 60) {
          userMarkers[id].setMap(null);
          delete userMarkers[id];
        }
      }

      map.fitBounds(bounds, { top: 50, bottom: 50, left: 50, right: 50 });
    });
  }

  function animateMarker(marker, newPos) {
    const duration = 1000;
    const steps = 20;
    const oldPos = marker.getPosition();
    const deltaLat = (newPos.lat - oldPos.lat()) / steps;
    const deltaLng = (newPos.lng - oldPos.lng()) / steps;
    let step = 0;

    function move() {
      const lat = oldPos.lat() + deltaLat * step;
      const lng = oldPos.lng() + deltaLng * step;
      marker.setPosition({ lat, lng });
      step++;
      if (step <= steps) requestAnimationFrame(move);
    }

    move();
  }

  async function getRoutePath(fromLat, fromLng, toLat, toLng) {
    try {
      const key = "5b3ce3597851110001cf624851251b0ba51a41d9800fbb30dac99a4c";
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${key}&start=${fromLng},${fromLat}&end=${toLng},${toLat}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.features[0].geometry.coordinates.map(c => ({ lat: c[1], lng: c[0] }));
    } catch (err) {
      console.warn("Route fetch failed:", err);
      return null;
    }
  }

  window.initMap = initMap;
</script>

<!-- Load Google Map -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDt5vnzRbwQtgqPDAXdDHA3mqXDmSbOMSI&callback=initMap"></script>
</body>
</html>
