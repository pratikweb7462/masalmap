<!DOCTYPE html>
<html>
<head>
  <title>Mashal Live Viewer (Enhanced)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100%; }
    .dark-mode { background-color: #121212; color: #f0f0f0; }
    .dark-mode .navbar { background-color: #000 !important; }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark shadow-sm">
  <div class="container-fluid justify-content-between">
    <span class="navbar-brand">üìç Live Delivery Viewer (Mashal)</span>
    <button class="btn btn-outline-light btn-sm" onclick="toggleDarkMode()">
      <i class="bi bi-moon-stars-fill"></i> Theme
    </button>
  </div>
</nav>

<div id="map"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDt5vnzRbwQtgqPDAXdDHA3mqXDmSbOMSI"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.appspot.com",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let map, bounds;
  const markers = {};
  const polylines = {};
  const mashalIcon = {
    url: 'https://www.silvertouch.com/mailer/fire-masal.png',
    scaledSize: new google.maps.Size(40, 40)
  };
  const directionsService = new google.maps.DirectionsService();

  function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
  }

  function animateMarker(marker, newPos) {
    const deltaLat = (newPos.lat() - marker.getPosition().lat()) / 60;
    const deltaLng = (newPos.lng() - marker.getPosition().lng()) / 60;
    let i = 0;
    const interval = setInterval(() => {
      if (i >= 60) return clearInterval(interval);
      const lat = marker.getPosition().lat() + deltaLat;
      const lng = marker.getPosition().lng() + deltaLng;
      marker.setPosition(new google.maps.LatLng(lat, lng));
      i++;
    }, 16); // ~1 second total animation
  }

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 22.9734, lng: 78.6569 },
      zoom: 6,
      restriction: {
        latLngBounds: { north: 37.1, south: 6.5, west: 67, east: 97.5 },
        strictBounds: true
      }
    });

    bounds = new google.maps.LatLngBounds();

    db.ref("liveUsers").on("value", snap => {
      const users = snap.val() || {};
      const now = Date.now();

      // Cleanup old markers and polylines
      for (const id in markers) {
        if (!users[id] || (now - users[id].timestamp > 60000)) {
          markers[id].setMap(null);
          if (polylines[id]) polylines[id].setMap(null);
          delete markers[id];
          delete polylines[id];
        }
      }

      for (const id in users) {
        const u = users[id];
        if ((now - u.timestamp) > 60000) continue;

        const currentPos = new google.maps.LatLng(u.lat, u.lng);
        bounds.extend(currentPos);

        if (markers[id]) {
          animateMarker(markers[id], currentPos);
        } else {
          const marker = new google.maps.Marker({
            position: currentPos,
            map,
            icon: mashalIcon,
            title: u.name
          });
          const info = new google.maps.InfoWindow({
            content: `<strong>${u.name}</strong><br>üìç ${u.destination || 'N/A'}`
          });
          marker.addListener("click", () => info.open(map, marker));
          markers[id] = marker;
        }

        // Draw or update route
        if (u.toLat && u.toLng) {
          const destLatLng = new google.maps.LatLng(u.toLat, u.toLng);
          directionsService.route({
            origin: currentPos,
            destination: destLatLng,
            travelMode: 'DRIVING'
          }, (res, status) => {
            if (status === "OK") {
              if (polylines[id]) polylines[id].setMap(null);
              const path = new google.maps.Polyline({
                path: res.routes[0].overview_path,
                geodesic: true,
                strokeColor: "#1E90FF",
                strokeOpacity: 0.7,
                strokeWeight: 4,
                map
              });
              polylines[id] = path;
            }
          });
        }
      }

      map.fitBounds(bounds);
    });
  }

  window.onload = initMap;
</script>
</body>
</html>
