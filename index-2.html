<!DOCTYPE html>
<html>
<head>
  <title>India Live GPS Tracker</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- jQuery + Bootstrap -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-database-compat.js"></script>

  <!-- Google Maps API (with your key) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDt5vnzRbwQtgqPDAXdDHA3mqXDmSbOMSI&libraries=places"></script>

  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 90vh; width: 100%; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h4 class="text-center mt-2">🇮🇳 India Live GPS Tracker with Route</h4>
    <div id="map"></div>
  </div>

  <script>
    // ✅ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
      authDomain: "myindiamapamritkal.firebaseapp.com",
      databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
      projectId: "myindiamapamritkal",
      storageBucket: "myindiamapamritkal.firebasestorage.app",
      messagingSenderId: "830924864737",
      appId: "1:830924864737:web:7a096f506d004e19358ba0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ✅ Constants
    const userId = "user_" + Math.floor(Math.random() * 10000);
    const iconUrl = "https://www.silvertouch.com/mailer/fire-masal.png";

    let map, myMarker;
    const markers = {};
    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer();

    function initMap(lat, lng) {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat, lng },
        zoom: 15,
      });

      directionsRenderer.setMap(map);

      myMarker = new google.maps.Marker({
        map,
        position: { lat, lng },
        icon: {
          url: iconUrl,
          scaledSize: new google.maps.Size(40, 40),
        },
        title: "You",
      });
    }

    function updateLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          if (!map) initMap(lat, lng);
          if (myMarker) myMarker.setPosition({ lat, lng });

          db.ref("locations/" + userId).set({
            lat,
            lng,
            name: "Fire Tracker"
          });
        });
      } else {
        alert("Geolocation not supported");
      }
    }

    function trackUsers() {
      db.ref("locations").on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        for (let id in data) {
          if (id === userId) continue;
          const { lat, lng, name } = data[id];

          if (!markers[id]) {
            markers[id] = new google.maps.Marker({
              map,
              position: { lat, lng },
              icon: {
                url: iconUrl,
                scaledSize: new google.maps.Size(40, 40),
              },
              title: name
            });

            // 🗺️ Click to route
            markers[id].addListener("click", () => {
              navigator.geolocation.getCurrentPosition((pos) => {
                const origin = {
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude
                };

                const destination = { lat, lng };

                directionsService.route({
                  origin,
                  destination,
                  travelMode: "WALKING"
                }, (result, status) => {
                  if (status === "OK") {
                    directionsRenderer.setDirections(result);
                  } else {
                    alert("Failed to get route: " + status);
                  }
                });
              });
            });

          } else {
            markers[id].setPosition({ lat, lng });
          }
        }
      });
    }

    // ✅ Start
    updateLocation();
    trackUsers();
  </script>
</body>
</html>
