<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi Delivery Tracker + Paths</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    #map { height: 100vh; width: 100%; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
  // ‚úÖ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.firebasestorage.app",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // üó∫Ô∏è Map Setup
  const map = L.map('map').setView([22.9734, 78.6569], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const warehouse = [28.6139, 77.2090]; // Delhi
  L.marker(warehouse).addTo(map).bindPopup("üè¢ Warehouse");

  const deliveryMarkers = {};
  const deliveryPolylines = {};
  const deliveryRoutes = {};
  const updateThrottle = 5000; // Minimum ms between route redraws per user
  const lastRouteUpdate = {};

  // üõ£Ô∏è Draw route from warehouse to latest point of delivery
  async function drawRouteToUser(deliveryId, lat, lng) {
    const coords = [[warehouse[1], warehouse[0]], [lng, lat]];
    const apiKey = '5b3ce3597851110001cf6248c9d85902f070459d880c6a22a6e467d6';
    const url = "https://corsproxy.io/?https://api.openrouteservice.org/v2/directions/driving-car";

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ coordinates: coords })
      });

      const data = await response.json();
      const routeCoords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);

      // Remove old route
      if (deliveryRoutes[deliveryId]) map.removeLayer(deliveryRoutes[deliveryId]);

      deliveryRoutes[deliveryId] = L.polyline(routeCoords, {
        color: "blue", dashArray: "5,5", weight: 3
      }).addTo(map);

    } catch (err) {
      console.error("Route error for", deliveryId, err);
    }
  }

  // üîÑ Listen to all users
  db.ref("locations").on("value", (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    Object.entries(data).forEach(([deliveryId, user]) => {
      const name = user.name || deliveryId;
      const path = user.path || [];

      if (path.length === 0) return;

      const latest = path[path.length - 1];
      const latlng = [latest.lat, latest.lng];

      // üìç Update marker
      if (!deliveryMarkers[deliveryId]) {
        deliveryMarkers[deliveryId] = L.marker(latlng, {
          icon: L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(map).bindPopup(`<strong>${name}</strong>`);
      } else {
        deliveryMarkers[deliveryId].setLatLng(latlng);
      }

      // ‚ûï Draw full path history
      const pathCoords = path.map(p => [p.lat, p.lng]);
      if (deliveryPolylines[deliveryId]) {
        map.removeLayer(deliveryPolylines[deliveryId]);
      }
      deliveryPolylines[deliveryId] = L.polyline(pathCoords, {
        color: 'green',
        weight: 4
      }).addTo(map);

      // üîÅ Throttle route drawing per user
      const now = Date.now();
      if (!lastRouteUpdate[deliveryId] || now - lastRouteUpdate[deliveryId] > updateThrottle) {
        drawRouteToUser(deliveryId, latest.lat, latest.lng);
        lastRouteUpdate[deliveryId] = now;
      }
    });
  });
</script>

</body>
</html>
