<!DOCTYPE html>
<html>
<head>
  <title>India Live Map - User Info + Routed</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map { height: 100vh; }
    #loginBtn {
      position: absolute; top: 10px; left: 10px;
      z-index: 1000; padding: 8px 16px; background: #007bff;
      color: #fff; border: none; border-radius: 5px;
      font-weight: bold;
    }
    .popup-user {
      display: flex; align-items: center; gap: 8px;
    }
    .popup-user img {
      border-radius: 50%; width: 40px; height: 40px;
    }
  </style>
</head>
<body>

<button id="loginBtn">Login with Google</button>
<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.firebasestorage.app",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const map = L.map("map").setView([21.1466, 79.0888], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const customIcon = L.icon({
    iconUrl: "https://www.silvertouch.com/mailer/fire-masal.png",
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

  let currentUser = null;
  const markers = {};
  const polylines = {};
  let routeLine = null;
  const userInfoMap = {}; // uid â†’ {name, photoURL}

  document.getElementById("loginBtn").addEventListener("click", () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then((result) => {
      currentUser = result.user;
      userInfoMap[currentUser.uid] = {
        name: currentUser.displayName,
        photo: currentUser.photoURL
      };
      startTracking();
    });
  });

  function startTracking() {
    if (!navigator.geolocation) {
      alert("Geolocation not supported");
      return;
    }
    navigator.geolocation.watchPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        db.ref("locations/" + currentUser.uid).push({
          lat, lng, timestamp: Date.now(),
          name: currentUser.displayName,
          photo: currentUser.photoURL
        });
      },
      (err) => console.error("Geolocation error:", err),
      { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
    );
  }

  async function drawRouteBetweenAllUsers(coordsList) {
    if (coordsList.length < 2) return;
    const formatted = coordsList.map(p => [p.lng, p.lat]);
    const response = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
      method: "POST",
      headers: {
        "Authorization": "5b3ce3597851110001cf6248c9d85902f070459d880c6a22a6e467d6",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ coordinates: formatted })
    });
    const data = await response.json();
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.geoJSON(data, { style: { color: "red", weight: 5 } }).addTo(map);
  }

  db.ref("locations").on("value", (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    const validCoords = [];

    for (const userId in data) {
      const all = Object.values(data[userId]).filter(l => l.lat && l.lng);
      if (all.length === 0) continue;

      const last = all[all.length - 1];
      validCoords.push({ userId, lat: last.lat, lng: last.lng });

      // store user name & photo if available
      if (!userInfoMap[userId] && last.name && last.photo) {
        userInfoMap[userId] = {
          name: last.name,
          photo: last.photo
        };
      }

      const name = userInfoMap[userId]?.name || userId;
      const photo = userInfoMap[userId]?.photo || "";

      const popupHtml = `
        <div class="popup-user">
          ${photo ? `<img src="${photo}" alt="Photo" />` : ""}
          <div><strong>${name}</strong></div>
        </div>
      `;

      if (!markers[userId]) {
        markers[userId] = L.marker([last.lat, last.lng], { icon: customIcon })
          .addTo(map)
          .bindPopup(popupHtml);
      } else {
        markers[userId].setLatLng([last.lat, last.lng]);
        markers[userId].setPopupContent(popupHtml);
      }

      if (polylines[userId]) map.removeLayer(polylines[userId]);
      const path = all.map(p => [p.lat, p.lng]);
      polylines[userId] = L.polyline(path, { color: "blue" }).addTo(map);
    }

    if (validCoords.length >= 2) {
      drawRouteBetweenAllUsers(validCoords);
    }
  });
</script>

</body>
</html>
