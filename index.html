<!DOCTYPE html>
<html>
<head>
  <title>India Live Map - Google Maps + Firebase</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
    #map { height: 100vh; width: 100%; }
    #topBar {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #topBar button, #topBar input {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
    }
    #loginBtn { background-color: #007bff; color: white; }
    #logoutBtn { background-color: #dc3545; color: white; }
    #searchInput { width: 250px; }
  </style>
</head>
<body>

<div id="topBar">
  <button id="loginBtn">Login with Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <input type="text" id="searchInput" placeholder="Search UID, Email, or Mobile" />
</div>

<div id="map"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-database-compat.js"></script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDt5vnzRbwQtgqPDAXdDHA3mqXDmSbOMSI"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.firebasestorage.app",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let map;
  let currentUser = null;
  const markers = {};
  const polylines = {};

  const customIcon = {
    url: "https://www.silvertouch.com/mailer/fire-masal.png",
    scaledSize: new google.maps.Size(40, 40)
  };

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 21.1466, lng: 79.0888 },
      zoom: 5,
    });
  }

  function login() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(result => {
      currentUser = result.user;
      document.getElementById("loginBtn").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      startTracking();
    });
  }

  function logout() {
    auth.signOut().then(() => location.reload());
  }

  function startTracking() {
    if (!navigator.geolocation) return alert("Geolocation not supported");
    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      const mobile = prompt("Enter your mobile number") || "Unknown";
      db.ref("locations/" + currentUser.uid).push({
        lat: latitude,
        lng: longitude,
        timestamp: Date.now(),
        name: currentUser.displayName,
        email: currentUser.email,
        photo: currentUser.photoURL,
        mobile: mobile
      });
    }, err => console.error(err), {
      enableHighAccuracy: true,
      timeout: 5000,
      maximumAge: 0
    });
  }

  function listenForUsers() {
    db.ref("locations").on("value", snapshot => {
      const data = snapshot.val();
      if (!data) return;
      const filter = document.getElementById("searchInput").value.toLowerCase();

      for (const uid in data) {
        const records = Object.values(data[uid]).filter(p => p.lat && p.lng);
        if (!records.length) continue;

        const latest = records[records.length - 1];
        const { lat, lng, name = "User", photo = "", mobile = "NA", email = "", timestamp } = latest;

        const matchFilter = (
          uid.toLowerCase().includes(filter) ||
          email.toLowerCase().includes(filter) ||
          mobile.toLowerCase().includes(filter)
        );
        if (filter && !matchFilter) {
          if (markers[uid]) markers[uid].setMap(null);
          if (polylines[uid]) polylines[uid].setMap(null);
          continue;
        }

        const isOnline = (Date.now() - timestamp < 30000); // 30 sec
        const statusIcon = `<span style="color:${isOnline ? 'green' : 'red'};">‚óè</span>`;

        const infoContent = `
          <div style="display:flex;align-items:center;gap:8px;">
            ${photo ? `<img src="${photo}" style="width:40px;height:40px;border-radius:50%;">` : ""}
            <div>
              <strong>${name}</strong> ${statusIcon}<br/>
              <small>${email}<br/>üì± ${mobile}</small>
            </div>
          </div>
        `;

        const latLng = { lat, lng };

        // Update or create marker
        if (!markers[uid]) {
          const marker = new google.maps.Marker({ position: latLng, map, icon: customIcon });
          const infoWindow = new google.maps.InfoWindow({ content: infoContent });
          marker.addListener("click", () => infoWindow.open(map, marker));
          markers[uid] = marker;
        } else {
          markers[uid].setPosition(latLng);
          markers[uid].setMap(map);
        }

        // Draw history path
        if (polylines[uid]) polylines[uid].setMap(null);
        const pathCoords = records.map(r => ({ lat: r.lat, lng: r.lng }));
        polylines[uid] = new google.maps.Polyline({
          path: pathCoords,
          strokeColor: "#007bff",
          strokeOpacity: 0.8,
          strokeWeight: 3,
          map
        });
      }
    });
  }

  document.getElementById("loginBtn").addEventListener("click", login);
  document.getElementById("logoutBtn").addEventListener("click", logout);
  document.getElementById("searchInput").addEventListener("input", listenForUsers);

  window.onload = () => {
    initMap();
    listenForUsers();
  };
</script>

</body>
</html>
