<!DOCTYPE html>
<html>
<head>
  <title>India Live Map - Leaflet + Firebase</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 100vh; }
    #topBar {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    #topBar button, #topBar input {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
    }
    #loginBtn { background-color: #007bff; color: white; }
    #logoutBtn { background-color: #dc3545; color: white; display: none; }
    #searchInput { width: 220px; }
    .popup-user {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .popup-user img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
    }
  </style>
</head>
<body>

<div id="topBar">
  <button id="loginBtn">Login with Google</button>
  <button id="logoutBtn">Logout</button>
  <input type="text" id="searchInput" placeholder="Search UID, Email or Mobile" />
</div>
<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-database-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.firebasestorage.app",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const map = L.map("map").setView([21.1466, 79.0888], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const customIcon = L.icon({
    iconUrl: "https://www.silvertouch.com/mailer/fire-masal.png",
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

  let currentUser = null;
  const markers = {};
  const polylines = {};
  const userInfoMap = {};

  document.getElementById("loginBtn").addEventListener("click", () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then((result) => {
      currentUser = result.user;
      document.getElementById("loginBtn").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      const mobile = prompt("Enter your mobile number") || "Unknown";
      userInfoMap[currentUser.uid] = {
        name: currentUser.displayName,
        email: currentUser.email,
        photo: currentUser.photoURL,
        mobile: mobile
      };
      startTracking();
    });
  });

  document.getElementById("logoutBtn").addEventListener("click", () => {
    auth.signOut().then(() => location.reload());
  });

  function startTracking() {
    if (!navigator.geolocation) {
      alert("Geolocation not supported");
      return;
    }
    navigator.geolocation.watchPosition(
      (pos) => {
        const { latitude: lat, longitude: lng } = pos.coords;
        const info = userInfoMap[currentUser.uid];
        db.ref("locations/" + currentUser.uid).push({
          lat, lng, timestamp: Date.now(),
          name: info.name,
          photo: info.photo,
          mobile: info.mobile,
          email: info.email
        });
      },
      (err) => console.error("Geolocation error:", err),
      { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
    );
  }

  function renderMap() {
    db.ref("locations").on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      const search = document.getElementById("searchInput").value.toLowerCase();

      for (const userId in data) {
        const all = Object.values(data[userId]).filter(l => l.lat && l.lng);
        if (all.length === 0) continue;

        const last = all[all.length - 1];
        const name = last.name || "User";
        const photo = last.photo || "";
        const mobile = last.mobile || "NA";
        const email = last.email || "";
        const timestamp = last.timestamp || 0;

        const match = userId.toLowerCase().includes(search) ||
                      email.toLowerCase().includes(search) ||
                      mobile.toLowerCase().includes(search);

        if (search && !match) {
          if (markers[userId]) map.removeLayer(markers[userId]);
          if (polylines[userId]) map.removeLayer(polylines[userId]);
          continue;
        }

        const isOnline = Date.now() - timestamp < 30000;
        const statusDot = `<span style="color:${isOnline ? "green" : "red"}">‚óè</span>`;

        const popupHtml = `
          <div class="popup-user">
            ${photo ? `<img src="${photo}" alt="Photo" />` : ""}
            <div>
              <strong>${name}</strong> ${statusDot}<br/>
              <small>${email}<br/>üì± ${mobile}</small>
            </div>
          </div>
        `;

        const latlng = [last.lat, last.lng];

        if (!markers[userId]) {
          markers[userId] = L.marker(latlng, { icon: customIcon })
            .addTo(map)
            .bindPopup(popupHtml);
        } else {
          markers[userId].setLatLng(latlng).bindPopup(popupHtml);
          if (!map.hasLayer(markers[userId])) map.addLayer(markers[userId]);
        }

        const path = all.map(p => [p.lat, p.lng]);
        if (polylines[userId]) map.removeLayer(polylines[userId]);
        polylines[userId] = L.polyline(path, { color: "blue" }).addTo(map);
      }
    });
  }

  document.getElementById("searchInput").addEventListener("input", renderMap);
  window.onload = () => renderMap();
</script>

</body>
</html>
