<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>India Delivery Tracker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: calc(100vh - 90px);
      width: 100%;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Header -->
  <nav class="navbar navbar-dark bg-primary px-3">
    <span class="navbar-brand mb-0 h1">ðŸ‡®ðŸ‡³ India Delivery Tracker</span>
    <span id="userInfo" class="text-white"></span>
    <button id="logoutDiv" class="btn btn-outline-light btn-sm d-none" onclick="logout()">Logout</button>
  </nav>

  <!-- Login Section -->
  <div id="loginDiv" class="container py-4 text-center">
    <div class="card mx-auto" style="max-width: 400px;">
      <div class="card-body">
        <h5 class="card-title">Login</h5>
        <button class="btn btn-danger w-100 mb-2" onclick="googleLogin()">Login with Google</button>
        <input type="text" id="phone" class="form-control mb-2" placeholder="Enter phone (+91...)">
        <div id="recaptcha-container"></div>
        <button class="btn btn-primary w-100 mb-2" onclick="phoneLogin()">Send OTP</button>
        <input type="text" id="otp" class="form-control mb-2 d-none" placeholder="Enter OTP">
        <button id="verifyBtn" class="btn btn-success w-100 d-none" onclick="verifyOTP()">Verify OTP</button>
      </div>
    </div>
  </div>

  <!-- Destination Form -->
  <div id="form" class="container py-3 d-none">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="input-group">
          <input id="destination" class="form-control" placeholder="Enter destination (e.g. Gandhinagar)">
          <button class="btn btn-success" onclick="startLiveTracking()">Start Tracking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Map -->
  <div id="map" class="d-none"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Your Script -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
      authDomain: "myindiamapamritkal.firebaseapp.com",
      databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
      projectId: "myindiamapamritkal",
      storageBucket: "myindiamapamritkal.firebasestorage.app",
      messagingSenderId: "830924864737",
      appId: "1:830924864737:web:7a096f506d004e19358ba0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let map, userId, userName = "", userPhone = "", userMarker = null, destMarker = null, routeLine = null;
    let destinationCoords = null;
    let userNamePrompted = false;

    const mashalIcon = L.icon({
      iconUrl: 'https://www.silvertouch.com/mailer/fire-masal.png',
      iconSize: [40, 40],
      iconAnchor: [40, 40],
      popupAnchor: [0, -60]
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        userName = user.displayName || user.phoneNumber || "User";
        userPhone = user.phoneNumber || "";

        if (user.displayName === null && !userNamePrompted) {
          const namePrompt = prompt("Enter your name:");
          if (namePrompt) {
            userName = namePrompt;
            userNamePrompted = true;
          }
        }

        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("form").classList.remove("d-none");
        document.getElementById("logoutDiv").classList.remove("d-none");
        document.getElementById("map").classList.remove("d-none");
        document.getElementById("userInfo").innerText = "Logged in as: " + userName;
        initMap();
      }
    });

    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(alert);
    }

    function phoneLogin() {
      const phone = document.getElementById("phone").value;
      setTimeout(() => {
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
          size: 'invisible'
        });
        auth.signInWithPhoneNumber(phone, window.recaptchaVerifier).then(confirmationResult => {
          window.confirmationResult = confirmationResult;
          document.getElementById("otp").classList.remove("d-none");
          document.getElementById("verifyBtn").classList.remove("d-none");
        }).catch(alert);
      }, 500);
    }

    function verifyOTP() {
      const otp = document.getElementById("otp").value;
      window.confirmationResult.confirm(otp).then(result => {
        const name = prompt("Enter your name:");
        if (name) {
          userName = name;
          userNamePrompted = true;
        }
      }).catch(alert);
    }

    function logout() {
      auth.signOut();
      location.reload();
    }

    function initMap() {
      map = L.map('map', {
        center: [22.9734, 78.6569],
        zoom: 5,
        minZoom: 5,
        maxZoom: 18,
        maxBounds: [[6.5, 67], [37.1, 97.5]],
        maxBoundsViscosity: 1.0
      });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);

      db.ref("liveUsers").on("value", snap => {
        const users = snap.val() || {};
        const now = Date.now();

        map.eachLayer(layer => {
          if (layer instanceof L.Marker && layer !== userMarker && layer !== destMarker) {
            map.removeLayer(layer);
          }
        });

        for (const id in users) {
          const u = users[id];
          const age = (now - u.timestamp) / 1000;
          if (age > 60) {
            db.ref("liveUsers/" + id).remove();
          } else if (id !== userId) {
            const marker = L.marker([u.lat, u.lng], { icon: mashalIcon })
              .addTo(map)
              .bindPopup(`${u.name || "User"}<br>${u.destination}`);
          }
        }
      });
    }

    async function geocodeLocation(name) {
      const orsKey = "5b3ce3597851110001cf624851251b0ba51a41d9800fbb30dac99a4c";
      const url = `https://api.openrouteservice.org/geocode/search?api_key=${orsKey}&text=${encodeURIComponent(name)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.features && data.features.length) {
        const [lng, lat] = data.features[0].geometry.coordinates;
        return { lat, lng };
      } else {
        throw new Error("Location not found");
      }
    }

    async function drawRoute(from, to) {
      const orsKey = "5b3ce3597851110001cf624851251b0ba51a41d9800fbb30dac99a4c";
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${orsKey}&start=${from.lng},${from.lat}&end=${to.lng},${to.lat}`;
      const res = await fetch(url);
      const json = await res.json();
      const coords = json.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      if (routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, { color: 'blue' }).addTo(map);
      map.fitBounds(routeLine.getBounds());
    }

    async function startLiveTracking() {
      const dest = document.getElementById("destination").value;
      if (!dest) return alert("Please enter destination.");
      try {
        destinationCoords = await geocodeLocation(dest);
        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker([destinationCoords.lat, destinationCoords.lng]).addTo(map)
          .bindPopup("Destination: " + dest).openPopup();
      } catch (e) {
        return alert("Failed to geocode destination.");
      }

      if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(pos => {
          const { latitude: lat, longitude: lng } = pos.coords;
          db.ref("liveUsers/" + userId).set({
            name: userName,
            lat,
            lng,
            destination: dest,
            toLat: destinationCoords.lat,
            toLng: destinationCoords.lng,
            timestamp: Date.now()
          });

          let popupContent = `<strong>${userName}</strong><br>`;
          if (auth.currentUser.photoURL) {
            popupContent += `<img src="${auth.currentUser.photoURL}" width="60" height="60" style="border-radius:50%;">`;
          }

          if (!userMarker) {
            userMarker = L.marker([lat, lng], { icon: mashalIcon }).addTo(map).bindPopup(popupContent).openPopup();
          } else {
            userMarker.setLatLng([lat, lng]);
            userMarker.setPopupContent(popupContent);
          }

          drawRoute({ lat, lng }, destinationCoords);
        }, err => alert("GPS error: " + err.message), {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000
        });
      } else {
        alert("Geolocation not supported.");
      }
    }
  </script>
</body>
</html>
