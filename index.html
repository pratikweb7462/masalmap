<!DOCTYPE html>
<html>

<head>
  <title>India Live Tracker (Login Required)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #map {
      height: 80vh;
      width: 100%;
      display: none;
    }

    .form-container {
      max-width: 500px;
      margin: auto;
      padding-top: 20px;
    }

    #logoutDiv {
      text-align: center;
      margin-top: 10px;
    }

    #userCard {
      display: none;
    }

    #spinner {
      display: none;
    }

    .leaflet-popup-content img {
      max-width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-top: 5px;
    }
  </style>
</head>

<body>

  <div class="container">
    <!-- Login Section -->
    <div id="loginDiv" class="form-container">
      <h2 class="text-center mb-4">Login to Track</h2>
      <div class="d-grid gap-2 mb-3">
        <button class="btn btn-danger" onclick="googleLogin()">Login with Google</button>
      </div>
      <input id="phone" class="form-control mb-2" placeholder="+91..." />
      <div id="recaptcha-container" class="mb-2"></div>
      <button class="btn btn-primary w-100 mb-2" onclick="phoneLogin()">Send OTP</button>
      <div class="input-group mb-3" style="display:none;" id="otpGroup">
        <input id="otp" class="form-control" placeholder="Enter OTP" />
        <button class="btn btn-success" onclick="verifyOTP()" id="verifyBtn">Verify</button>
      </div>
    </div>

    <!-- Logout and User Card -->
    <div id="logoutDiv" style="display:none;" class="text-end mt-3">
      <button class="btn btn-outline-dark btn-sm" onclick="logout()">Logout</button>
    </div>

    <div id="userCard" class="card mb-3" style="max-width: 500px; margin: auto;">
      <div class="card-body d-flex align-items-center gap-3">
        <img id="userPhoto" src="" class="rounded-circle" width="60" height="60" style="display: none;">
        <div>
          <h5 class="card-title mb-1" id="cardName"></h5>
          <p class="card-text mb-0"><strong>Destination:</strong> <span id="cardDest">N/A</span></p>
        </div>
      </div>
    </div>

    <!-- Tracking Form -->
    <div id="form" class="form-container" style="display:none;">
      <div class="input-group mb-3">
        <input id="destination" class="form-control" placeholder="Destination (e.g., Gandhinagar)" />
        <button class="btn btn-primary" onclick="startLiveTracking()">Start Tracking</button>
      </div>
      <div id="spinner" class="text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Tracking...</span>
        </div>
        <p class="text-muted mt-2">Tracking live location...</p>
      </div>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
      authDomain: "myindiamapamritkal.firebaseapp.com",
      databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
      projectId: "myindiamapamritkal",
      storageBucket: "myindiamapamritkal.firebasestorage.app",
      messagingSenderId: "830924864737",
      appId: "1:830924864737:web:7a096f506d004e19358ba0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let map, userId, userName = "", userPhone = "", userMarker = null, destMarker = null, routeLine = null;
    let destinationCoords = null;
    let userNamePrompted = false;

    const mashalIcon = L.icon({
      iconUrl: 'https://www.silvertouch.com/mailer/fire-masal.png',
      iconSize: [40, 40],
      iconAnchor: [40, 40],
      popupAnchor: [0, -60]
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        userName = user.displayName || user.phoneNumber || "User";
        userPhone = user.phoneNumber || "";

        if (!user.displayName && !userNamePrompted) {
          const namePrompt = prompt("Enter your name:");
          if (namePrompt) {
            userName = namePrompt;
            userNamePrompted = true;
          }
        }

        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("form").style.display = "block";
        document.getElementById("logoutDiv").style.display = "block";
        document.getElementById("map").style.display = "block";
        document.getElementById("userCard").style.display = "block";

        document.getElementById("cardName").innerText = userName;
        if (user.photoURL) {
          const photo = document.getElementById("userPhoto");
          photo.src = user.photoURL;
          photo.style.display = "block";
        }

        initMap();
      }
    });

    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(alert);
    }

    function phoneLogin() {
      const phone = document.getElementById("phone").value;
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        size: 'invisible'
      });
      auth.signInWithPhoneNumber(phone, window.recaptchaVerifier).then(confirmationResult => {
        window.confirmationResult = confirmationResult;
        document.getElementById("otpGroup").style.display = "flex";
      }).catch(alert);
    }

    function verifyOTP() {
      const otp = document.getElementById("otp").value;
      window.confirmationResult.confirm(otp).then(result => {
        const name = prompt("Enter your name:");
        if (name) {
          userName = name;
          userNamePrompted = true;
        }
      }).catch(alert);
    }

    function logout() {
      auth.signOut();
      location.reload();
    }

    function initMap() {
      map = L.map('map', {
        center: [22.9734, 78.6569],
        zoom: 5,
        minZoom: 5,
        maxZoom: 18,
        maxBounds: [[6.5, 67], [37.1, 97.5]],
        maxBoundsViscosity: 1.0
      });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);

      db.ref("liveUsers").on("value", snap => {
        const users = snap.val() || {};
        const now = Date.now();

        map.eachLayer(layer => {
          if (layer instanceof L.Marker && layer !== userMarker && layer !== destMarker) {
            map.removeLayer(layer);
          }
        });

        for (const id in users) {
          const u = users[id];
          const age = (now - u.timestamp) / 1000;

          if (age > 60) {
            db.ref("liveUsers/" + id).remove();
          } else if (id !== userId) {
            const marker = L.marker([u.lat, u.lng], { icon: mashalIcon })
              .addTo(map)
              .bindPopup(`${u.name || "User"}<br>${u.destination}`);
          }
        }
      });
    }

    async function geocodeLocation(name) {
      const orsKey = "5b3ce3597851110001cf624851251b0ba51a41d9800fbb30dac99a4c";
      const url = `https://api.openrouteservice.org/geocode/search?api_key=${orsKey}&text=${encodeURIComponent(name)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.features && data.features.length) {
        const [lng, lat] = data.features[0].geometry.coordinates;
        return { lat, lng };
      } else {
        throw new Error("Location not found");
      }
    }

    async function drawRoute(from, to) {
      const orsKey = "5b3ce3597851110001cf624851251b0ba51a41d9800fbb30dac99a4c";
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${orsKey}&start=${from.lng},${from.lat}&end=${to.lng},${to.lat}`;
      const res = await fetch(url);
      const json = await res.json();
      const coords = json.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      if (routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, { color: 'blue' }).addTo(map);
      map.fitBounds(routeLine.getBounds());
    }

    async function startLiveTracking() {
      const dest = document.getElementById("destination").value;
      if (!dest) return alert("Please enter destination.");

      try {
        document.getElementById("spinner").style.display = "block";
        destinationCoords = await geocodeLocation(dest);
        document.getElementById("cardDest").innerText = dest;

        if (destMarker) map.removeLayer(destMarker);
        destMarker = L.marker([destinationCoords.lat, destinationCoords.lng]).addTo(map)
          .bindPopup("Destination: " + dest).openPopup();
      } catch (e) {
        return alert("Failed to geocode destination.");
      }

      if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(pos => {
          const { latitude: lat, longitude: lng } = pos.coords;

          // âœ… Hide the loader after getting location
          document.getElementById("spinner").style.display = "none";

          db.ref("liveUsers/" + userId).set({
            name: userName,
            lat,
            lng,
            destination: dest,
            toLat: destinationCoords.lat,
            toLng: destinationCoords.lng,
            timestamp: Date.now()
          });

          let popupContent = `<strong>${userName}</strong><br>`;
          if (auth.currentUser.photoURL) {
            popupContent += `<img src="${auth.currentUser.photoURL}" width="60" height="60">`;
          }

          if (!userMarker) {
            userMarker = L.marker([lat, lng], { icon: mashalIcon }).addTo(map).bindPopup(popupContent).openPopup();
          } else {
            userMarker.setLatLng([lat, lng]);
            userMarker.setPopupContent(popupContent);
          }

          drawRoute({ lat, lng }, destinationCoords);
        }, err => alert("GPS error: " + err.message), {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000
        });

      } else {
        alert("Geolocation not supported.");
      }
    }
  </script>

</body>

</html>
