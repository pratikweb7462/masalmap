<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Debug: Firebase Delivery Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    #map { height: 100vh; width: 100vw; margin: 0; padding: 0; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
  // âœ… 1. Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.firebasestorage.app",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // âœ… 2. Setup Leaflet Map
  const map = L.map('map').setView([22.9734, 78.6569], 5); // India center
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // ðŸ¢ Warehouse marker (Delhi)
  const warehouse = [28.6139, 77.2090];
  L.marker(warehouse).addTo(map).bindPopup("ðŸ¢ Warehouse");

  // ðŸ”„ 3. Track one delivery user
  const deliveryId = "delivery123";
  const userRef = db.ref("locations/" + deliveryId);
  let marker, polyline, routeLine;

  // ðŸ§­ 4. Route Drawing Function
  async function drawRoute(lat, lng) {
    console.log("ðŸšš Drawing route to:", lat, lng);

    const coords = [[warehouse[1], warehouse[0]], [lng, lat]];
    const apiKey = "5b3ce3597851110001cf6248c9d85902f070459d880c6a22a6e467d6";
    const url = "https://corsproxy.io/?https://api.openrouteservice.org/v2/directions/driving-car";

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ coordinates: coords })
      });

      const data = await res.json();
      console.log("âœ… Route response:", data);

      const route = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      if (routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(route, { color: 'blue', dashArray: '5,5' }).addTo(map);
      map.fitBounds(routeLine.getBounds());

    } catch (err) {
      console.error("âŒ Route fetch error", err);
    }
  }

  // ðŸ” 5. Firebase listener
  userRef.on("value", snapshot => {
    const data = snapshot.val();
    console.log("ðŸ“¡ Firebase data:", data);

    if (!data || !data.path || data.path.length === 0) {
      console.warn("âš ï¸ No path found for delivery123");
      return;
    }

    const path = data.path;
    const last = path[path.length - 1];
    const latlng = [last.lat, last.lng];

    // â¬‡ï¸ Update or create marker
    if (!marker) {
      marker = L.marker(latlng, {
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        })
      }).addTo(map).bindPopup("ðŸšš Delivery: " + (data.name || deliveryId)).openPopup();
    } else {
      marker.setLatLng(latlng);
    }

    // â¬‡ï¸ Draw full path
    const points = path.map(p => [p.lat, p.lng]);
    if (polyline) map.removeLayer(polyline);
    polyline = L.polyline(points, { color: 'green' }).addTo(map);

    // ðŸ§­ Redraw route
    drawRoute(last.lat, last.lng);
  });
</script>

</body>
</html>
