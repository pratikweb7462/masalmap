<!DOCTYPE html>
<html>
<head>
  <title>Mappls Admin Live Tracker</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet and Mappls -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://apis.mappls.com/advancedmaps/v1/3613a4d240f8da7df8e8f0dc14410fbc/map_load?v=1.5"></script>
  <script src="https://apis.mappls.com/advancedmaps/v1/3613a4d240f8da7df8e8f0dc14410fbc/leaflet_plugin.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100%; }
  </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark p-2 text-white">
  <div class="container-fluid">
    <span class="navbar-brand mb-0">üìç Admin - Live Tracking (Mappls)</span>
  </div>
</nav>

<div id="map"></div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBesWChEdJEZRFRkXE8rpynY0lBez47SJA",
    authDomain: "myindiamapamritkal.firebaseapp.com",
    databaseURL: "https://myindiamapamritkal-default-rtdb.firebaseio.com",
    projectId: "myindiamapamritkal",
    storageBucket: "myindiamapamritkal.appspot.com",
    messagingSenderId: "830924864737",
    appId: "1:830924864737:web:7a096f506d004e19358ba0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const mashalIcon = L.icon({
    iconUrl: 'https://www.silvertouch.com/mailer/fire-masal.png',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

  let map, userMarkers = {}, userBounds = [];

  // Wait until L.mappls is available
  function waitForMappls(callback) {
    if (window.L && L.mappls && L.mappls.tileLayer) {
      callback();
    } else {
      setTimeout(() => waitForMappls(callback), 100);
    }
  }

  // Initialize Map
  function initMap() {
    map = L.map('map', {
      center: [22.9734, 78.6569],
      zoom: 5,
      minZoom: 5,
      maxZoom: 18,
      maxBounds: [[6.5, 67], [37.1, 97.5]],
      maxBoundsViscosity: 1.0
    });

    // Mappls tiles
    L.mappls.tileLayer().addTo(map);

    loadLiveUsers();
  }

  function loadLiveUsers() {
    db.ref("liveUsers").on("value", snap => {
      const users = snap.val() || {};
      const now = Date.now();
      userBounds = [];

      for (const id in users) {
        const u = users[id];
        const age = (now - u.timestamp) / 1000;
        if (age > 60) continue;

        const latlng = [u.lat, u.lng];
        userBounds.push(latlng);

        const popup = `
          <strong>${u.name || 'User'}</strong><br>
          Destination: ${u.destination || 'N/A'}<br>
          ${u.photoURL ? `<img src="${u.photoURL}" width="60" height="60">` : ''}
        `;

        if (!userMarkers[id]) {
          userMarkers[id] = L.marker(latlng, { icon: mashalIcon }).addTo(map).bindPopup(popup);
        } else {
          userMarkers[id].setLatLng(latlng).setPopupContent(popup);
        }
      }

      // Remove old users
      for (const id in userMarkers) {
        if (!(id in users) || (now - users[id]?.timestamp) / 1000 > 60) {
          map.removeLayer(userMarkers[id]);
          delete userMarkers[id];
        }
      }

      // Fit map to active users
      if (userBounds.length) {
        const bounds = L.latLngBounds(userBounds);
        map.fitBounds(bounds, { padding: [50, 50] });
      }
    });
  }

  // Delay map until L.mappls ready
  waitForMappls(() => {
    initMap();
    setTimeout(() => map.invalidateSize(), 200);
  });
</script>

</body>
</html>
